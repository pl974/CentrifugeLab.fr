---
/**
 * Composant Témoignages avec Schema.org Review
 * TODO: Remplacer les témoignages fictifs par de vrais avis clients
 *
 * Recommandations SEO:
 * - Minimum 5-10 témoignages authentiques
 * - Inclure nom complet, entreprise, poste
 * - Photos réelles des clients (avec autorisation RGPD)
 * - Dates récentes (6-12 derniers mois)
 * - Diversifier les types d'applications/secteurs
 */

interface Testimonial {
  id: string;
  author: string;
  position: string;
  company: string;
  rating: number; // 1-5
  date: string; // ISO format: YYYY-MM-DD
  text: string;
  avatar?: string; // URL vers photo (optionnel)
  productReviewed?: string; // Produit spécifique
}

interface Props {
  title?: string;
  maxItems?: number;
  showProductContext?: boolean;
}

const {
  title = "Ils nous font confiance",
  maxItems = 6,
  showProductContext = false
} = Astro.props;

// TODO: Remplacer par de vrais témoignages clients
// Collectez des avis authentiques avec:
// - Email de demande après installation
// - Google My Business reviews
// - Enquêtes de satisfaction
// - Études de cas clients
const testimonials: Testimonial[] = [
  {
    id: "1",
    author: "Dr. Marie Dubois",
    position: "Responsable Laboratoire",
    company: "CHU de [VILLE]", // TODO: Ville réelle
    rating: 5,
    date: "2025-09-15",
    text: "Excellent équipement, très performant pour nos analyses quotidiennes. Le service après-vente est réactif et professionnel. Formation complète des équipes appréciée.",
    productReviewed: "Centrifugeuse Réfrigérée CR-4000"
  },
  {
    id: "2",
    author: "Jean-Pierre Martin",
    position: "Directeur R&D",
    company: "BioTech Innovation", // TODO: Entreprise réelle
    rating: 5,
    date: "2025-08-22",
    text: "La précision et la fiabilité de cette ultracentrifugeuse sont exceptionnelles. Indispensable pour nos recherches en biologie moléculaire. Investissement rentabilisé rapidement.",
    productReviewed: "Ultracentrifugeuse UC-150K"
  },
  {
    id: "3",
    author: "Sophie Lefebvre",
    position: "Technicienne de Laboratoire",
    company: "Laboratoire d'Analyses [NOM]", // TODO: Nom réel
    rating: 4,
    date: "2025-08-10",
    text: "Interface intuitive, maintenance facile. Utilisation quotidienne depuis 18 mois sans aucun problème. Le contrat de maintenance nous assure une tranquillité totale.",
    productReviewed: "Centrifugeuse de Paillasse BP-5000"
  },
  {
    id: "4",
    author: "Prof. Laurent Rousseau",
    position: "Chercheur Senior",
    company: "CNRS - Institut [NOM]", // TODO: Institut réel
    rating: 5,
    date: "2025-07-28",
    text: "Support technique exceptionnel. L'équipe CentrifugeLab a su nous conseiller le modèle parfaitement adapté à nos besoins spécifiques en protéomique.",
    productReviewed: "Ultracentrifugeuse UC-100K"
  },
  {
    id: "5",
    author: "Caroline Mercier",
    position: "Responsable Qualité",
    company: "Pharma Solutions [VILLE]", // TODO: Entreprise réelle
    rating: 5,
    date: "2025-07-05",
    text: "Conformité parfaite aux normes ISO. Documentation technique complète. Formation certifiée pour nos opérateurs. Partenaire de confiance depuis 3 ans.",
    productReviewed: "Centrifugeuse Réfrigérée CR-6000"
  },
  {
    id: "6",
    author: "Thomas Bernard",
    position: "Chef de Projet",
    company: "Laboratoire Vétérinaire [RÉGION]", // TODO: Région réelle
    rating: 4,
    date: "2025-06-18",
    text: "La location nous a permis de tester avant achat. Service flexible et sans engagement. Équipement livré et installé en 48h. Très satisfait de la réactivité.",
    productReviewed: "Centrifugeuse de Paillasse BP-4500"
  }
];

// Limiter le nombre d'avis affichés
const displayedTestimonials = testimonials.slice(0, maxItems);

// Calcul de la note moyenne
const averageRating = (testimonials.reduce((sum, t) => sum + t.rating, 0) / testimonials.length).toFixed(1);
---

<!-- Schema.org AggregateRating + Reviews -->
<script type="application/ld+json" set:html={JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "CentrifugeLab",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": averageRating,
    "reviewCount": testimonials.length,
    "bestRating": "5",
    "worstRating": "1"
  },
  "review": testimonials.map(testimonial => ({
    "@type": "Review",
    "author": {
      "@type": "Person",
      "name": testimonial.author,
      "jobTitle": testimonial.position,
      "worksFor": {
        "@type": "Organization",
        "name": testimonial.company
      }
    },
    "datePublished": testimonial.date,
    "reviewRating": {
      "@type": "Rating",
      "ratingValue": testimonial.rating,
      "bestRating": "5",
      "worstRating": "1"
    },
    "reviewBody": testimonial.text,
    ...(testimonial.productReviewed && {
      "itemReviewed": {
        "@type": "Product",
        "name": testimonial.productReviewed
      }
    })
  }))
})} />

<section class="testimonials-section py-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- En-tête -->
    <div class="text-center mb-12">
      <h2 class="text-3xl font-bold text-gray-900 mb-4">{title}</h2>
      <div class="flex items-center justify-center gap-2 mb-2">
        <!-- Étoiles de notation moyenne -->
        {Array.from({ length: 5 }).map((_, i) => (
          <svg
            class={`w-6 h-6 ${i < Math.floor(parseFloat(averageRating)) ? 'text-yellow-400' : 'text-gray-300'}`}
            viewBox="0 0 24 24"
            fill="currentColor"
            aria-hidden="true"
          >
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
        ))}
      </div>
      <p class="text-gray-600">
        <span class="font-semibold text-lg">{averageRating}/5</span>
        <span class="text-sm ml-2">basé sur {testimonials.length} avis clients</span>
      </p>
    </div>

    <!-- Grille de témoignages -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
      {displayedTestimonials.map((testimonial) => (
        <article
          class="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow"
          itemscope
          itemtype="https://schema.org/Review"
        >
          <!-- Note en étoiles -->
          <div class="flex items-center mb-4">
            {Array.from({ length: 5 }).map((_, i) => (
              <svg
                class={`w-5 h-5 ${i < testimonial.rating ? 'text-yellow-400' : 'text-gray-300'}`}
                viewBox="0 0 24 24"
                fill="currentColor"
                aria-hidden="true"
              >
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            ))}
            <span class="sr-only" itemprop="reviewRating" itemscope itemtype="https://schema.org/Rating">
              <meta itemprop="ratingValue" content={testimonial.rating.toString()} />
              <meta itemprop="bestRating" content="5" />
              Note: {testimonial.rating}/5
            </span>
          </div>

          <!-- Texte du témoignage -->
          <blockquote class="text-gray-700 mb-4 italic" itemprop="reviewBody">
            "{testimonial.text}"
          </blockquote>

          {/* Produit évalué (si applicable) */}
          {showProductContext && testimonial.productReviewed && (
            <div class="text-sm text-gray-500 mb-3 italic" itemprop="itemReviewed" itemscope itemtype="https://schema.org/Product">
              Produit: <span itemprop="name">{testimonial.productReviewed}</span>
            </div>
          )}

          <!-- Auteur -->
          <footer class="flex items-start border-t pt-4" itemprop="author" itemscope itemtype="https://schema.org/Person">
            {/* Avatar (si disponible) */}
            {testimonial.avatar ? (
              <img
                src={testimonial.avatar}
                alt={`Photo de ${testimonial.author}`}
                class="w-12 h-12 rounded-full mr-4 object-cover"
                itemprop="image"
              />
            ) : (
              <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mr-4 flex-shrink-0">
                <span class="text-blue-600 font-semibold text-lg">
                  {testimonial.author.split(' ').map(n => n[0]).join('')}
                </span>
              </div>
            )}

            <div class="flex-1 min-w-0">
              <p class="font-semibold text-gray-900 truncate" itemprop="name">
                {testimonial.author}
              </p>
              <p class="text-sm text-gray-600 truncate" itemprop="jobTitle">
                {testimonial.position}
              </p>
              <p class="text-sm text-gray-500 truncate" itemprop="worksFor" itemscope itemtype="https://schema.org/Organization">
                <span itemprop="name">{testimonial.company}</span>
              </p>
              <time
                class="text-xs text-gray-400 mt-1 block"
                datetime={testimonial.date}
                itemprop="datePublished"
              >
                {new Date(testimonial.date).toLocaleDateString('fr-FR', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                })}
              </time>
            </div>
          </footer>
        </article>
      ))}
    </div>

    <!-- CTA pour laisser un avis -->
    <div class="mt-12 text-center bg-blue-50 rounded-lg p-8">
      <h3 class="text-xl font-semibold mb-3">Vous êtes client CentrifugeLab ?</h3>
      <p class="text-gray-600 mb-6">
        Partagez votre expérience pour aider d'autres professionnels dans leur choix
      </p>
      <a
        href="/contact/?subject=avis"
        class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"
      >
        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Laisser un Avis
      </a>
    </div>
  </div>
</section>

<style>
  .testimonials-section {
    background: linear-gradient(180deg, #f9fafb 0%, #ffffff 100%);
  }
</style>
