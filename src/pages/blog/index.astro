---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// Récupérer tous les articles de blog (exclure les brouillons)
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

// Trier par date de publication (plus récent en premier)
const sortedPosts = allPosts.sort((a, b) =>
  b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Grouper par catégorie pour filtrage
const categories = [
  { id: 'all', label: 'Tous les articles', count: sortedPosts.length },
  { id: 'guides', label: 'Guides', count: sortedPosts.filter(p => p.data.category === 'guides').length },
  { id: 'actualites', label: 'Actualités', count: sortedPosts.filter(p => p.data.category === 'actualites').length },
  { id: 'reglementation', label: 'Réglementation', count: sortedPosts.filter(p => p.data.category === 'reglementation').length },
  { id: 'cas-pratiques', label: 'Cas Pratiques', count: sortedPosts.filter(p => p.data.category === 'cas-pratiques').length },
  { id: 'conseils', label: 'Conseils', count: sortedPosts.filter(p => p.data.category === 'conseils').length },
  { id: 'maintenance', label: 'Maintenance', count: sortedPosts.filter(p => p.data.category === 'maintenance').length },
];

// Articles à la une
const featuredPosts = sortedPosts.filter(p => p.data.featured === true).slice(0, 2);

// Formater la date en français
const formatDate = (date: Date) => {
  return new Date(date).toLocaleDateString('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

const pageTitle = "Blog Centrifugation | Guides, Actualités & Conseils d'Experts";
const pageDescription = "Découvrez nos guides d'achat, actualités réglementaires et conseils d'experts pour optimiser l'utilisation de vos centrifugeuses de laboratoire.";
---

<Layout
  title={pageTitle}
  description={pageDescription}
>
  <!-- Schema.org Blog -->
  <script type="application/ld+json" slot="head" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Blog",
    "name": "Blog CentrifugeLab",
    "description": pageDescription,
    "url": "https://centrifugelab.fr/blog/",
    "publisher": {
      "@type": "Organization",
      "name": "CentrifugeLab",
      "logo": {
        "@type": "ImageObject",
        "url": "https://centrifugelab.fr/logo.png"
      }
    },
    "blogPost": sortedPosts.slice(0, 10).map(post => ({
      "@type": "BlogPosting",
      "headline": post.data.title,
      "description": post.data.description,
      "datePublished": post.data.pubDate.toISOString(),
      "author": {
        "@type": "Person",
        "name": post.data.author
      },
      "url": `https://centrifugelab.fr/blog/${post.slug}/`
    }))
  })} />

  <!-- Hero Section -->
  <section class="bg-gradient-to-br from-blue-600 to-blue-800 text-white py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">Blog CentrifugeLab</h1>
      <p class="text-xl md:text-2xl text-blue-100 max-w-3xl">
        Guides d'achat, actualités réglementaires et conseils d'experts pour optimiser vos équipements de laboratoire
      </p>
    </div>
  </section>

  <!-- Articles à la Une -->
  {featuredPosts.length > 0 && (
    <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <h2 class="text-3xl font-bold text-gray-900 mb-8">À la Une</h2>
      <div class="grid md:grid-cols-2 gap-8">
        {featuredPosts.map((post) => (
          <article class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
            {post.data.image && (
              <img
                src={post.data.image.src}
                alt={post.data.image.alt}
                class="w-full h-64 object-cover"
                loading="eager"
              />
            )}
            <div class="p-6">
              <div class="flex items-center gap-3 mb-3">
                <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-sm font-semibold rounded-full">
                  {categories.find(c => c.id === post.data.category)?.label}
                </span>
                <time class="text-sm text-gray-500" datetime={post.data.pubDate.toISOString()}>
                  {formatDate(post.data.pubDate)}
                </time>
              </div>
              <h3 class="text-2xl font-bold text-gray-900 mb-3">
                <a href={`/blog/${post.slug}/`} class="hover:text-blue-600 transition-colors">
                  {post.data.title}
                </a>
              </h3>
              <p class="text-gray-700 mb-4 line-clamp-3">
                {post.data.description}
              </p>
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-600">
                  Par {post.data.author}
                </span>
                <a
                  href={`/blog/${post.slug}/`}
                  class="inline-flex items-center text-blue-600 hover:text-blue-800 font-semibold"
                >
                  Lire l'article
                  <svg class="w-4 h-4 ml-1" aria-hidden="true" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </a>
              </div>
            </div>
          </article>
        ))}
      </div>
    </section>
  )}

  <!-- Filtres par Catégorie -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 border-t">
    <div class="flex flex-wrap gap-3 mb-8">
      {categories.map((cat) => (
        <button
          data-category={cat.id}
          class="category-filter px-4 py-2 rounded-lg border border-gray-300 hover:border-blue-600 hover:bg-blue-50 transition-colors"
        >
          {cat.label} <span class="text-gray-500">({cat.count})</span>
        </button>
      ))}
    </div>

    <!-- Grille d'Articles -->
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
      {sortedPosts.map((post) => (
        <article
          class="blog-post bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-md transition-shadow"
          data-category={post.data.category}
        >
          {post.data.image && (
            <img
              src={post.data.image.src}
              alt={post.data.image.alt}
              class="w-full h-48 object-cover"
              loading="lazy"
            />
          )}
          <div class="p-6">
            <div class="flex items-center gap-3 mb-3">
              <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">
                {categories.find(c => c.id === post.data.category)?.label}
              </span>
              <time class="text-xs text-gray-500" datetime={post.data.pubDate.toISOString()}>
                {formatDate(post.data.pubDate)}
              </time>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">
              <a href={`/blog/${post.slug}/`} class="hover:text-blue-600 transition-colors">
                {post.data.title}
              </a>
            </h3>
            <p class="text-gray-700 text-sm mb-4 line-clamp-3">
              {post.data.description}
            </p>
            <div class="flex items-center justify-between text-sm">
              <span class="text-gray-600">
                {post.data.author}
              </span>
              <a
                href={`/blog/${post.slug}/`}
                class="text-blue-600 hover:text-blue-800 font-semibold"
              >
                Lire →
              </a>
            </div>
          </div>
        </article>
      ))}
    </div>
  </section>

  <!-- CTA Newsletter -->
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="bg-blue-50 rounded-lg p-8 text-center">
      <h2 class="text-2xl font-bold text-gray-900 mb-3">Restez Informé</h2>
      <p class="text-gray-700 mb-6 max-w-2xl mx-auto">
        Recevez nos derniers articles, guides d'achat et actualités réglementaires directement dans votre boîte mail
      </p>
      <form class="max-w-md mx-auto flex gap-3">
        <input
          type="email"
          placeholder="votre@email.fr"
          required
          class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
        <button
          type="submit"
          class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors"
        >
          S'abonner
        </button>
      </form>
      <p class="text-xs text-gray-500 mt-3">
        Pas de spam. Désinscription en un clic. Conforme RGPD.
      </p>
    </div>
  </section>
</Layout>

<script>
  // Filtrage par catégorie
  const categoryFilters = document.querySelectorAll('.category-filter');
  const blogPosts = document.querySelectorAll('.blog-post');

  categoryFilters.forEach(filter => {
    filter.addEventListener('click', () => {
      const selectedCategory = filter.getAttribute('data-category');

      // Mettre à jour les boutons actifs
      categoryFilters.forEach(f => {
        f.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
        f.classList.add('border-gray-300');
      });
      filter.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
      filter.classList.remove('border-gray-300');

      // Filtrer les articles
      blogPosts.forEach(post => {
        const postCategory = post.getAttribute('data-category');
        if (selectedCategory === 'all' || postCategory === selectedCategory) {
          post.style.display = 'block';
        } else {
          post.style.display = 'none';
        }
      });
    });
  });
</script>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
